<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Muvie</title>
  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/bricklayer/0.4.2/bricklayer.min.css">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/bricklayer/0.4.2/bricklayer.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css?family=Comfortaa:700|Open+Sans');

    @media screen and (min-width: 1200px) {
      .bricklayer-column-sizer {
        /* divide by 4. */
        width: 25%;
      }
    }

    @media screen and (min-width: 768px) {
      .bricklayer-column-sizer {
        /* divide by 3. */
        width: 20%;
      }
    }

    @media screen and (min-width: 320px and max-width:768px;
    ) {
      .bricklayer-column-sizer {
        /* divide by 1. */
        width: 100%;
      }
    }

    body,
    html {
      margin: 0;
      padding: 0;
      font-size: 16px;
      /*background-color: #81CBFB;*/
      font-family: 'Open Sans', sans-serif;
    }

    .container {
      margin: 0 4rem;
    }

    .card {
      width: 100%;
      background-color: rgba(190, 190, 190, 0.3);
      margin-bottom: 1rem;
      border-radius: 10px;
      overflow: hidden;
    }

    .img {
      width: 100%;
      height: auto;
    }

    .brand {
      margin-top: 5rem;
      font-size: 3rem;
      color: #000;
      font-family: 'Comfortaa', cursive;
    }

    .title {
      font-size: 2em;
    }

    .content {
      margin-top: 4rem;
    }


    .card .title {
      font-size: 1rem;
      font-weight: 700;
      line-height: 1rem;
      margin: 0;
      padding: 1rem;
      text-align: center;
    }
    .popup {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(50, 186, 93, 0.8);
      z-index: 10;
    }

    .hide {
      display: none;
    }

    .btn-close {
      width: 3rem;
      height: 3rem;
      position: fixed;
      font-size: 0;
      top: 2rem;
      right: 2rem;
      background: url({{ url_for('static',filename='img/close.png') }}) center center/100% auto no-repeat;
      z-index: 99;
    }
   .popup .container{
     margin:0;
     width: 100%;
     text-align: center;
     position: absolute;
     top: 50%;
     transform: translateY(-50%);
   }
    .video-box {
      /*width: 100%;
      text-align: center;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);*/
    }
    .popup .title{
      margin-top: -2rem;
      font-size: 2rem;
      line-height: 2rem;
      text-align: center;
      width: 100%;
      /*width: 100%;
      text-align: center;
      font-size: 2rem;
      position: absolute;
      top: ;*/
    }
    .notice{
      position: absolute;
      width: 100%;
      color: #fff;
      font-size: 20px;
      text-align: center;
      top: 50%;
      transform: translateY(-50%);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="brand">Muvie</div>
    </div>
    <div>
      <h1 class="title">These are the movies recommended for you based on your recent playlist:</h1>
    </div>
    <div class="content" id="mvlist">
      <div class="bricklayer">
        {% for movie in movies %}
        <div>
          <div class="card" data-name="{{movie.Title}}">
          	<div class="img-box">
            <img class="img" src="{{ movie.Poster }}" alt="{{ movie.Title }}">
            </div>
            <p class="title">{{ movie.Title }}</p>
          </div>
        </div>
        {% endfor %}
        <!-- <div>
          <div class="card" data-name="interstellar">
            <img class="img" src="img/interstellar.jpg" alt="Interstellar">
            <p class="title">Interstellar</p>
          </div>
        </div>
        <div>
          <div class="card" data-name="Amelie">
            <img class="img" src="img/amelie.jpg" alt="Amelie">
            <p class="title">Amelie</p>
          </div>
        </div>
        <div>
          <div class="card" data-name="Moonlight">
            <img class="img" src="img/moonlight.jpg" alt="Moonlight">
            <p class="title">Moonlight</p>
          </div>
        </div>
        <div>
          <div class="card" data-name="Amelie">
            <img class="img" src="img/amelie.jpg" alt="Amelie">
            <p class="title">Amelie</p>
          </div>
        </div>
        <div>
          <div class="card" data-name="moonlight">
            <img class="img" src="img/moonlight.jpg" alt="Moonlight">
            <p class="title">Moonlight</p>
          </div>
        </div>
        <div>
          <div class="card" data-name="interstellar">
            <img class="img" src="img/interstellar.jpg" alt="Interstellar">
            <p class="title">A super loooooong long long long movie name</p>
          </div>
        </div> -->

      </div>

      <div class="popup hide" id="popup">
        <div class="btn-close" id="btn_popup">
          X
        </div>
        <div class="container">
          <div class="title">
            <h1 id='m_name'>Movie Name</h1>
          </div>
          <div class="video-box" id="video_box">
            <!-- <iframe width="560" height="315" src="https://www.youtube.com/embed/zSWdZVtXT7E" frameborder="0" allowfullscreen></iframe> -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    var bricklayer = new Bricklayer(document.querySelector('.bricklayer'));
    var cards = document.getElementsByClassName('card');
    var list = document.getElementById('mvlist');
    var popup = document.getElementById('popup');
    var btnClose = document.getElementById('btn_popup');
    var videoBox = document.getElementById('video_box');
    var tName = '';

    list.addEventListener('click', function(ev) {
      var target = ev.target || ev.srcElement;

      var t = target;

      while (t.className !== 'card') {
        t = t.parentNode;
        if (t.id == 'mvlist') {
          t = null;
          break;
        }
      }
      if (t) {
        tName = t.dataset['name'];
        initPopup(tName);
      }

    }, true);


    function initPopup(name) {
      popup.className = 'popup';
      btnClose.addEventListener('click', function(ev) {
        popup.className = 'popup hide';
      }, true);
      var movieTitle = document.getElementById('m_name');
      movieTitle.innerText = name;

      // call youtube search API, get videoId
      p = {
        'maxResults': '1',
        'part': 'snippet',
        'q': name + '%20trailer',
        'type': ''
      };

      get('https://www.googleapis.com/youtube/v3/search', p);
    }


    function get(api, parameter) {
      var url = api + '?';
      const API_KEY = 'AIzaSyBmKZX_MnWGKUr3f67KVqRgytVyUgaRJZU';
      var vid = '',
          src = '',
          html = '';
      if(parameter){
        for(var p in parameter){
          url += p + '=' + parameter[p] + '&';
        }

        url += 'key=' + API_KEY;
      }


      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open("GET", url, false); // false for synchronous request
      xmlHttp.onreadystatechange = function() {
        if (xmlHttp.readyState === XMLHttpRequest.DONE && xmlHttp.status === 200) {
          var res = JSON.parse(xmlHttp.responseText);

          if(res && res['items'].length != 0){
            vid = res.items[0].id.videoId;
          }

          if(vid == ''){
            html = '<p class="notice">Oops, trailer not available now :(</p>'
          }else{
            src = 'https://www.youtube.com/embed/' + vid;
            html = '<iframe width="800" height="450" src="' + src + '" frameborder="0" allowfullscreen></iframe>';
          }

          videoBox.innerHTML = html;

        }
      };
      xmlHttp.send();
    }
  </script>
</body>

</html>
